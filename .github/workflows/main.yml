name: "Build Site and Deploy"

on:
  push:
    branches: "release"
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Install Nix
      uses: cachix/install-nix-action@v12
      with:
        install_url: https://github.com/numtide/nix-flakes-installer/releases/download/nix-2.4pre20201221_9fab14a/install
        extra_nix_config: |
          experimental-features = nix-command flakes
    - name: Compile Document
      run: nix run ./#compile
    - name: Disable Jekyll rendering
      run: touch build/site/.nojekyll

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Setup preview (Download release)
      if: github.event_name == "pull_request"
      uses: actions/checkout@v2
      with:
        ref: gh-pages
        path: release
    - name: Setup preview (move preview)
      if: github.event_name == "pull_request"
      run: |
        export PR_PATH="./gh-pages/preview/${{ github.event.pull_request.number }}"
        mkdir -p $PR_PATH
        rm -r $PR_PATH/* || true
        cp -r build/site $PR_PATH
        mv ./gh_pages build/site



    - name: Deploy
      uses: crazy-max/ghaction-github-pages@v2
      with:
        target_branch: gh-pages
        build_dir: build/site
        committer_name: github-ci
        committer-email: notifications+ci-blog@ysndr.de
      env:
        GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
  always-run:
    runs-on: ubuntu-latest
    steps:
    - name: Be friendly
      run: |
            echo "This is just here to prevent failure if the commit is not supposed to be build."
            echo "Don't mind, have a joke :)"
            echo "$(curl -Ss https://icanhazdadjoke.com/)"
